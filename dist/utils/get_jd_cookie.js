import e from"request";import t from"fs";import o from"path";var r={};const n=(i="string"==typeof $argument&&$argument||"",Object.fromEntries(i.split("&").map((e=>e.split("=")))));var i;Number(n.debug);var s=Number(n.deleteCookie),l=function(){const r="undefined"!=typeof $request,n="undefined"!=typeof $httpClient,i="undefined"!=typeof $task,s="undefined"!=typeof $loon,l="undefined"!=typeof $app&&"undefined"!=typeof $http,f=!l,u="CookieSet.json",d=(()=>{if(f){return{request:e,fs:t,path:o}}return null})(),p=(e,t,o,r,n)=>(void 0!==a&&t&&(a[t].notify?a[t].notify+=`\n${e}: 异常, 已输出日志 ‼️ (2)`:a[t].notify=`${e}: 异常, 已输出日志 ‼️`,a[t].error=1),console.log(`\n‼️${e}发生错误\n‼️名称: ${o.name}\n‼️描述: ${o.message}${JSON.stringify(o).match(/"line"/)?`\n‼️行列: ${JSON.stringify(o)}`:""}${r&&r.status?`\n‼️状态: ${r.status}`:""}${n?`\n‼️响应: ${r&&503!=r.status?n:"Omit."}`:""}`));return{AnError:p,isRequest:r,isJSBox:l,isSurge:n,isQuanX:i,isLoon:s,isNode:f,notify:(e,t,o,r)=>{const a=e=>{if(!e)return e;if("string"==typeof e)return s?e:i?{"open-url":e}:n?{url:e}:void 0;if("object"==typeof e){if(s){return{openUrl:e.openUrl||e.url||e["open-url"],mediaUrl:e.mediaUrl||e["media-url"]}}if(i){return{"open-url":e["open-url"]||e.url||e.openUrl,"media-url":e["media-url"]||e.mediaUrl}}if(n){return{url:e.url||e.openUrl||e["open-url"]}}}};console.log(`${e}\n${t}\n${o}`),i&&$notify(e,t,o,a(r)),n&&$notification.post(e,t,o,a(r)),l&&$push.schedule({title:e,body:t?t+"\n"+o:o})},write:(e,t)=>{if(i)return $prefs.setValueForKey(e,t);if(n)return $persistentStore.write(e,t);if(f)try{d.fs.existsSync(d.path.resolve(__dirname,u))||d.fs.writeFileSync(d.path.resolve(__dirname,u),JSON.stringify({}));const o=JSON.parse(d.fs.readFileSync(d.path.resolve(__dirname,u)));return e&&(o[t]=e),e||delete o[t],d.fs.writeFileSync(d.path.resolve(__dirname,u),JSON.stringify(o))}catch(e){return p("Node.js持久化写入",null,e)}return l?e?$file.write({data:$data({string:e}),path:`shared://${t}.txt`}):$file.delete(`shared://${t}.txt`):void 0},read:e=>{if(i)return $prefs.valueForKey(e);if(n)return $persistentStore.read(e);if(f)try{return d.fs.existsSync(d.path.resolve(__dirname,u))?JSON.parse(d.fs.readFileSync(d.path.resolve(__dirname,u)))[e]:null}catch(e){return p("Node.js持久化读取",null,e)}return l?$file.exists(`shared://${e}.txt`)?$file.read(`shared://${e}.txt`).string:null:void 0},done:(e={})=>{if(i)return $done(e);n&&(r?$done(e):$done())}}}(),a={};const f="CookiesJD";function u(e,t,o="cookie"){let r,n,i=(e||t||"").split(/pt_pin=(.+?);/)[1],s=l.read(f);try{s=d(JSON.parse(s||"[]"))}catch(e){l.notify("京东签到","","Cookie JSON格式不正确, 即将清空\n可前往日志查看该数据内容!"),console.log(`京东签到Cookie JSON格式异常: ${e.message||e}\n旧数据内容: ${s}`),s=[]}for(let e=0;e<s.length;e++)if(s[e].cookie&&new RegExp(`pt_pin=${i};`).test(s[e].cookie)){r=e;break}return t&&void 0!==r?(n=s[r][o]===t?-1:2,s[r][o]=t,r+=1):t&&"cookie"===o&&(s.push({cookie:t}),n=1,r=s.length),{total:d(s),type:n,item:r,name:decodeURIComponent(i)}}function d(e){let t,o,r={};return e.reduce(((e,n)=>(o=((n.cookie||"").match(/(pt_key|pt_pin)=.+?;/g)||[]).sort(),2==o.length?(t=o[1])&&!r[t]&&(n.userName=n.userName?n.userName:decodeURIComponent(t.split(/pt_pin=(.+?);/)[1]),n.cookie=o.join(""),n.jrBody&&!n.jrBody.includes("reqData=")&&(console.log(`异常钢镚Body已过滤: ${n.jrBody}`),delete n.jrBody),r[t]=e.push(n)):console.log(`异常京东Cookie已过滤: ${n.cookie}`),e)),[])}(async function(){if(s){const e=l.write("",f);throw new Error(`Cookie清除${e?"成功":"失败"}, 请手动关闭脚本内"DeleteCookie"选项`)}if(!l.isRequest)throw new Error("脚本终止, 未获取Cookie ‼️");!function(){const e=$request;if("OPTIONS"!=e.method&&e.headers){const t=e.headers.Cookie||e.headers.cookie||"",o=t.match(/(pt_key|pt_pin)=.+?;/g);if(/^https:\/\/(me-|)api(\.m|)\.jd\.com\/(client\.|api)/.test(e.url)){if(!o||2!=o.length)throw new Error("写入Cookie失败, 关键值缺失\n可能原因: 非网页获取 ‼️");{const e=u(null,o.join(""));if(-1!==e.type){const t=l.write(JSON.stringify(e.total,null,2),"CookiesJD");l.notify(`用户名: ${e.name}`,"",`${2==e.type?"更新":"写入"}京东 [账号${e.item}] Cookie${t?"成功 🎉":"失败 ‼️"}`)}else console.log(`\n用户名: ${e.name}\n与历史京东 [账号${e.item}] Cookie相同, 跳过写入 ⚠️`)}}else if(/^https:\/\/ms\.jr\.jd\.com\/gw\/generic\/hy\/h5\/m\/appSign\?/.test(e.url)&&e.body){const o=u(t,e.body,"jrBody");if(!o.type)throw new Error("写入钢镚Body失败\n未获取该账号Cookie或关键值缺失‼️");{const e=l.write(JSON.stringify(o.total,null,2),"CookiesJD");l.notify(`用户名: ${o.name}`,"",`获取京东 [账号${o.item}] 钢镚Body${e?"成功 🎉":"失败 ‼️"}`)}}else if("http://www.apple.com/"===e.url)throw new Error("类型错误, 手动运行请选择上下文环境为Cron ⚠️")}else if(!e.headers)throw new Error("写入Cookie失败, 请检查匹配URL或配置内脚本类型 ⚠️")}()})().catch((e=>{l.notify("京东签到","",e.message||JSON.stringify(e))})).finally((()=>{l.isJSBox&&$intents.finish(l.st),l.done()}));export{r as default};
